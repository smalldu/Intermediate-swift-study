### Websocket

websocket握手需要借助于http协议，建立连接后通信过程使用websocket协议
该websocket连接还是基于我们刚才发起http连接的那个TCP连接。一旦建立连接之后，我们就可以进行数据传输了，websocket提供两种数据传输：文本数据和二进制数据。

websocket采取的方式是让所有客户端连接服务端，服务器将不同客户端发送给自己的消息进行转发或者广播，而对于原始的socket，只要两端建立连接之后，就可以发送端对端的数据，不需要经过第三方的转发

##### 主流IM 协议 

- XMPP协议： 
    + 优点：基于xml协议，容易理解，使用广泛，易于扩展。
    + 缺点：流量大，在移动终端也耗电。交互过程复杂。多被pc时代的产品使用，不适合移动时代的IM产品，即使我们基于xmpp进行改进，简化握手过程，改进文件传输机制，但是它的基因决定了如何改进，他都不适合移动互联网时代的IM产品。就像凤姐无论怎么整容，也变成不了高圆圆一样。
- MQTT协议：
    + 优点：适配多平台。
    + 缺点：协议简单，但是需要自己扩展好友，群组等功能。
- 私有协议：
    + 优点：随心所欲，自己定义，流量小。
    + 缺点：工作量巨大，扩展性差，需要考虑全面。
- Protobuf协议：
    + 优点：非常小、非常快、非常简单，一条消息数据用Protobuf序列化后的大小是JSON的1/10、XML格式的1/20、是二进制序列化的1/10。
    + 缺点：不能表示复杂的数据结构，但是对于IM来讲，已经足够。强烈推荐此协议。





#### 需要解决的问题 

- 长连接的稳定性
- 弱网络环境下的稳定性 
- 数据存储策略 


做过IM的小伙伴们都知道，我们真正需要心跳机制的原因其实主要是在于国内运营商NAT超时。
国内的运营商一般NAT超时的时间为5分钟，所以通常我们心跳设置的时间间隔为3-5分钟


PingPong机制:

很多小伙伴可能又会感觉到疑惑了，那么我们在这心跳间隔的3-5分钟如果连接假在线（例如在地铁电梯这种环境下）。那么我们岂不是无法保证消息的即时性么？这显然是我们无法接受的，所以业内的解决方案是采用双向的PingPong机制。

当服务端发出一个Ping，客户端没有在约定的时间内返回响应的ack，则认为客户端已经不在线，这时我们Server端会主动断开Scoket连接，并且改由APNS推送的方式发送消息。

同样的是，当客户端去发送一个消息，因为我们迟迟无法收到服务端的响应ack包，则表明客户端或者服务端已不在线，我们也会显示消息发送失败，并且断开Scoket连接。

重连机制:

- 自己主动去断开的Scoket连接（例如退出账号，APP退出到后台等等），不需要重连。其他的连接断开，我们都需要进行断线重连。
- 解决方案是尝试重连几次，如果仍旧无法重连成功，那么不再进行重连。
第一次立刻重连，第二次2秒，第三次4秒，第四次8秒...直到大于64秒就不再重连


QoS（Quality of Service， 服务质量 ）指一个网络能够利用各种基础技术，为指定的 网络通信 提供更好的服务能力, 是网络的一种安全机制， 是用来解决网络延迟和阻塞等问题的一种技术。

确保信息送到 

数据传输 json 
微信 QQ 使用的 Protobuf 性能很高
传输格式的时候：ProtocolBuffer > Json > XML


文件上传 ： 语音 图片 视频     又拍云  

安全性： 防DNS污染   单点登录等 

本地缓存策略 ： 










